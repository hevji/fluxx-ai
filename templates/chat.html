<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gemma Chat — Conversations</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;700&family=DM+Sans:wght@400;600&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet" />

  <link rel="stylesheet" href="/static/css/style.css" />
</head>
<body>

  <!--
    Auth overlay — shown by chat.js when no valid session token is found.
    Flask also passes `logged_in` from the template context; both guards apply.
  -->
  <div class="auth-overlay" id="auth-overlay">
    <h2>You need to login for chatting.</h2>
    <p>Please sign in to access your conversations.</p>
    <a href="/" class="btn-primary">Go to Login</a>
  </div>

  {% if not logged_in %}
  <!-- Server-side: no session cookie found — show overlay immediately -->
  <script>document.getElementById("auth-overlay").style.display = "flex";</script>
  {% endif %}

  <!-- ── App shell ──────────────────────────────────────────── -->
  <div class="chat-layout">

    <!-- ── Sidebar ─────────────────────────────────────────── -->
    <aside class="sidebar">

      <div class="sidebar-header">
        <div class="sidebar-logo">⬡ Gemma Chat</div>

        <!--
          New chat button → calls createNewChat() in chat.js
          Generates a UUID on the server, updates the URL to /c/<uuid>
        -->
        <button class="btn-new-chat" id="btn-new-chat">
          <!-- Plus icon (inline SVG, no external dependency) -->
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M7 1V13M1 7H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          New Chat
        </button>
      </div>

      <!-- Chat list — populated dynamically by chat.js -->
      <ul class="chat-list" id="chat-list"></ul>

      <!-- Sidebar footer: user info + logout -->
      <div class="sidebar-footer">
        <div class="user-avatar">
          <!-- First letter of email shown here via JS; placeholder for now -->
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/>
          </svg>
        </div>
        <!-- Filled in by chat.js once auth is confirmed -->
        <span id="user-email">...</span>
        <button class="btn-logout" id="btn-logout" title="Log out">
          ← Out
        </button>
      </div>

    </aside>

    <!-- ── Main conversation panel ────────────────────────── -->
    <main class="main-panel">

      <div class="main-header">
        <!-- Shows current chat UUID for debugging; could display chat title instead -->
        gemma-2b · local model
      </div>

      <!--
        Messages container.
        Populated by chat.js → appendMessage().
        Shows a placeholder when no chat is open.
      -->
      <div class="messages-panel" id="messages-panel">
        <div class="empty-chat">Select or create a chat to get started.</div>
      </div>

      <!--
        Input bar — hidden until a chat is selected (display toggled in chat.js).
        Send triggers: clicking #send-btn or pressing Enter (not Shift+Enter).
      -->
      <div class="chat-input-area" id="chat-input-area">
        <textarea
          id="msg-input"
          rows="1"
          placeholder="Message Gemma…"
          maxlength="8000"
        ></textarea>

        <button id="send-btn" title="Send">
          <!-- Arrow-up send icon -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 19V5M5 12l7-7 7 7"/>
          </svg>
        </button>
      </div>

    </main>
  </div>

  <!-- Firebase client SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <!-- Firebase config -->
  <script src="/static/js/firebase-config.js"></script>

  <!-- Chat application logic -->
  <script src="/static/js/chat.js"></script>

  <!-- Auto-resize textarea as user types -->
  <script>
    const ta = document.getElementById("msg-input");
    if (ta) {
      ta.addEventListener("input", () => {
        ta.style.height = "auto";
        ta.style.height = Math.min(ta.scrollHeight, 180) + "px";
      });
    }
  </script>
</body>
</html>
