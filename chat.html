<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gemma Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:wght@300;400;500&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #0c0c0e;
      --surface:   #131316;
      --surface2:  #1a1a1f;
      --surface3:  #222228;
      --border:    #2a2a32;
      --accent:    #c8522a;
      --accent-lo: rgba(200,82,42,.15);
      --text:      #eeede8;
      --muted:     #7a7975;
      --faint:     #3a3a42;
      --sidebar:   240px;
      --font-d:    "Instrument Serif", serif;
      --font-b:    "DM Sans", sans-serif;
      --font-m:    "JetBrains Mono", monospace;
    }

    html, body { height: 100%; overflow: hidden; background: var(--bg); color: var(--text); font-family: var(--font-b); }

    /* ── Layout ── */
    .shell {
      display: flex;
      height: 100vh;
    }

    /* ══ SIDEBAR ══════════════════════════════════════════ */
    .sidebar {
      width: var(--sidebar);
      min-width: var(--sidebar);
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-top {
      padding: 1.1rem 1rem .9rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: .7rem;
    }

    .logo {
      font-family: var(--font-d);
      font-style: italic;
      font-size: 1.05rem;
      color: var(--accent);
      letter-spacing: .01em;
    }

    /* New chat button */
    .btn-new {
      display: flex;
      align-items: center;
      gap: .5rem;
      width: 100%;
      background: var(--accent-lo);
      border: 1px solid rgba(200,82,42,.3);
      color: var(--accent);
      font-family: var(--font-b);
      font-size: .82rem;
      font-weight: 500;
      border-radius: 6px;
      padding: .55rem .9rem;
      cursor: pointer;
      transition: background 120ms;
    }
    .btn-new:hover { background: rgba(200,82,42,.25); }

    /* Chat list */
    .chat-list {
      flex: 1;
      overflow-y: auto;
      list-style: none;
      padding: .5rem 0;
      scrollbar-width: thin;
      scrollbar-color: var(--faint) transparent;
    }
    .chat-list::-webkit-scrollbar { width: 3px; }
    .chat-list::-webkit-scrollbar-thumb { background: var(--faint); }

    .chat-item {
      display: flex;
      align-items: center;
      gap: .35rem;
      padding: .48rem .9rem;
      cursor: pointer;
      transition: background 100ms;
      border-left: 2px solid transparent;
    }
    .chat-item:hover { background: var(--surface2); }
    .chat-item.active {
      background: var(--surface2);
      border-left-color: var(--accent);
    }

    .chat-item-title {
      flex: 1;
      font-size: .82rem;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: color 100ms;
    }
    .chat-item.active .chat-item-title,
    .chat-item:hover .chat-item-title { color: var(--text); }

    .del-btn {
      font-size: .72rem;
      color: var(--faint);
      border: none;
      background: none;
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 3px;
      opacity: 0;
      transition: opacity 100ms, color 100ms;
      flex-shrink: 0;
    }
    .chat-item:hover .del-btn { opacity: 1; }
    .del-btn:hover { color: #e05252; background: rgba(224,82,82,.12); }

    .list-empty {
      padding: 1.2rem 1rem;
      font-size: .8rem;
      color: var(--faint);
      text-align: center;
    }

    /* Sidebar footer — home link */
    .sidebar-foot {
      padding: .7rem 1rem;
      border-top: 1px solid var(--border);
    }
    .home-link {
      font-size: .78rem;
      color: var(--muted);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: .4rem;
      transition: color 120ms;
    }
    .home-link:hover { color: var(--text); }

    /* ══ MAIN ═════════════════════════════════════════════ */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--bg);
    }

    .main-bar {
      padding: .8rem 1.4rem;
      border-bottom: 1px solid var(--border);
      font-family: var(--font-m);
      font-size: .68rem;
      color: var(--faint);
      letter-spacing: .1em;
      text-transform: uppercase;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .model-badge {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 100px;
      padding: .22rem .7rem;
      font-size: .65rem;
      color: var(--muted);
    }

    /* Messages */
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 1.6rem 1.4rem;
      display: flex;
      flex-direction: column;
      gap: 1.1rem;
      scrollbar-width: thin;
      scrollbar-color: var(--faint) transparent;
    }
    .messages::-webkit-scrollbar { width: 3px; }
    .messages::-webkit-scrollbar-thumb { background: var(--faint); }

    /* Empty state */
    .empty-state {
      margin: auto;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: .7rem;
    }
    .empty-icon {
      font-family: var(--font-d);
      font-style: italic;
      font-size: 3.5rem;
      color: var(--faint);
      line-height: 1;
    }
    .empty-state p { font-size: .9rem; color: var(--faint); }

    /* Bubbles */
    .msg { display: flex; }
    .msg.user      { justify-content: flex-end; }
    .msg.assistant { justify-content: flex-start; }

    .bubble {
      max-width: 68%;
      padding: .7rem 1rem;
      border-radius: 14px;
      font-size: .9rem;
      line-height: 1.68;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .msg.user .bubble {
      background: var(--surface3);
      border-bottom-right-radius: 4px;
    }
    .msg.assistant .bubble {
      background: var(--surface);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
      color: var(--text);
    }

    /* Typing dots */
    .typing-dots { display: flex; gap: 5px; align-items: center; padding: .2rem 0; }
    .typing-dots span {
      width: 6px; height: 6px;
      background: var(--muted);
      border-radius: 50%;
      animation: dot-bounce 1.1s infinite ease;
    }
    .typing-dots span:nth-child(2) { animation-delay: .18s; }
    .typing-dots span:nth-child(3) { animation-delay: .36s; }
    @keyframes dot-bounce {
      0%,80%,100% { transform: translateY(0); opacity: .4; }
      40%          { transform: translateY(-6px); opacity: 1; }
    }

    /* Input row */
    .input-row {
      padding: .9rem 1.4rem;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: flex-end;
      gap: .7rem;
      flex-shrink: 0;
    }

    #msg-input {
      flex: 1;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: .7rem 1rem;
      color: var(--text);
      font-family: var(--font-b);
      font-size: .92rem;
      resize: none;
      max-height: 160px;
      outline: none;
      transition: border-color 120ms;
      scrollbar-width: thin;
    }
    #msg-input::placeholder { color: var(--faint); }
    #msg-input:focus { border-color: var(--accent); }

    #send-btn {
      width: 40px; height: 40px;
      background: var(--accent);
      border: none;
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: background 120ms, transform 120ms;
    }
    #send-btn:hover { background: #d96030; transform: scale(1.05); }
    #send-btn:active { transform: scale(.96); }
    #send-btn:disabled { background: var(--surface3); cursor: not-allowed; transform: none; }

    /* Responsive */
    @media (max-width: 600px) {
      :root { --sidebar: 200px; }
      .bubble { max-width: 88%; }
    }
  </style>
</head>
<body>
<div class="shell">

  <!-- ── Sidebar ──────────────────────────────────────── -->
  <aside class="sidebar">
    <div class="sidebar-top">
      <div class="logo">Gemma Chat</div>
      <button class="btn-new" id="btn-new">
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
          <path d="M6 1v10M1 6h10" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
        </svg>
        New chat
      </button>
    </div>

    <!-- Populated by JS -->
    <ul class="chat-list" id="chat-list"></ul>

    <div class="sidebar-foot">
      <a class="home-link" href="/">
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
          <path d="M7 9L4 6l3-3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Home
      </a>
    </div>
  </aside>

  <!-- ── Main panel ────────────────────────────────────── -->
  <main class="main">
    <div class="main-bar">
      <span id="chat-label">Select a chat</span>
      <span class="model-badge">gemma-2b · local</span>
    </div>

    <div class="messages" id="messages">
      <div class="empty-state" id="empty-state">
        <div class="empty-icon">g.</div>
        <p>Start a new chat or select one from the sidebar.</p>
      </div>
    </div>

    <div class="input-row">
      <textarea id="msg-input" rows="1" placeholder="Message Gemma…" maxlength="8000"></textarea>
      <button id="send-btn" disabled title="Send (Enter)">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path d="M8 13V3M3 8l5-5 5 5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </main>

</div>

<script>
// ═══════════════════════════════════════════════════════════
// chat.js — inline (no build step needed)
//
// The backend API is expected at the same origin (Flask on localhost:5000).
// If you later split frontend/backend, set API_BASE to the Flask URL, e.g.:
//   const API_BASE = "http://localhost:5000";
// ═══════════════════════════════════════════════════════════

const API_BASE = "";   // same origin — change if Flask runs on a different port

let activeChatId = null;

// ── DOM refs ────────────────────────────────────────────────
const chatList   = document.getElementById("chat-list");
const messages   = document.getElementById("messages");
const emptyState = document.getElementById("empty-state");
const msgInput   = document.getElementById("msg-input");
const sendBtn    = document.getElementById("send-btn");
const chatLabel  = document.getElementById("chat-label");

// ── Init ────────────────────────────────────────────────────
document.addEventListener("DOMContentLoaded", async () => {
  await loadChatList();

  // If URL is /c/<uuid>, open that chat
  const parts = location.pathname.split("/").filter(Boolean);
  if (parts.length === 2 && parts[0] === "c") {
    await openChat(parts[1]);
  }

  document.getElementById("btn-new").addEventListener("click", createChat);

  sendBtn.addEventListener("click", sendMessage);
  msgInput.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });

  // Enable/disable send button based on input content
  msgInput.addEventListener("input", () => {
    sendBtn.disabled = !msgInput.value.trim();
    // Auto-grow
    msgInput.style.height = "auto";
    msgInput.style.height = Math.min(msgInput.scrollHeight, 160) + "px";
  });
});

// ── API helper ──────────────────────────────────────────────
async function api(path, opts = {}) {
  const res = await fetch(API_BASE + path, {
    headers: { "Content-Type": "application/json" },
    ...opts,
  });
  if (!res.ok) return null;
  return res.json();
}

// ── Chat list ───────────────────────────────────────────────
async function loadChatList() {
  const chats = await api("/api/chats");
  renderList(chats || []);
}

function renderList(chats) {
  chatList.innerHTML = "";
  if (!chats.length) {
    chatList.innerHTML = `<li class="list-empty">No chats yet</li>`;
    return;
  }
  chats.forEach(c => {
    const li = document.createElement("li");
    li.className = "chat-item" + (c.id === activeChatId ? " active" : "");
    li.dataset.id = c.id;
    li.innerHTML = `
      <span class="chat-item-title" title="${esc(c.title)}">${esc(c.title)}</span>
      <button class="del-btn" data-id="${c.id}" title="Delete">✕</button>
    `;
    li.querySelector(".chat-item-title").addEventListener("click", () => openChat(c.id));
    li.querySelector(".del-btn").addEventListener("click", e => {
      e.stopPropagation();
      deleteChat(c.id);
    });
    chatList.appendChild(li);
  });
}

// ── Create chat ─────────────────────────────────────────────
async function createChat() {
  const chat = await api("/api/chats", { method: "POST", body: JSON.stringify({}) });
  if (!chat) return;
  await loadChatList();
  await openChat(chat.id);
}

// ── Delete chat ─────────────────────────────────────────────
async function deleteChat(id) {
  if (!confirm("Delete this chat?")) return;
  await api(`/api/chats/${id}`, { method: "DELETE" });
  if (id === activeChatId) {
    activeChatId = null;
    clearPanel();
    history.pushState(null, "", "/c/");
  }
  await loadChatList();
}

// ── Open chat ────────────────────────────────────────────────
async function openChat(id) {
  activeChatId = id;
  history.pushState(null, "", `/c/${id}`);

  // Highlight sidebar item
  document.querySelectorAll(".chat-item").forEach(el =>
    el.classList.toggle("active", el.dataset.id === id)
  );

  const chat = await api(`/api/chats/${id}`);
  if (!chat) { return; }

  chatLabel.textContent = chat.title || "Chat";
  clearPanel();

  (chat.messages || []).forEach(m => addBubble(m.role, m.content));

  sendBtn.disabled = false;
  msgInput.focus();
  scrollDown();
}

function clearPanel() {
  messages.innerHTML = `
    <div class="empty-state" id="empty-state">
      <div class="empty-icon">g.</div>
      <p>Start typing to chat with Gemma.</p>
    </div>`;
  sendBtn.disabled = true;
}

// ── Send message ─────────────────────────────────────────────
async function sendMessage() {
  if (!activeChatId) return;
  const text = msgInput.value.trim();
  if (!text) return;

  addBubble("user", text);
  msgInput.value = "";
  msgInput.style.height = "auto";
  sendBtn.disabled = true;
  scrollDown();

  // Typing indicator
  const typing = addTyping();

  // POST to backend
  // ── To connect Gemma: edit generate_reply() in app.py ──
  const result = await api(`/api/chats/${activeChatId}/messages`, {
    method: "POST",
    body: JSON.stringify({ message: text }),
  });

  typing.remove();

  if (!result) {
    addBubble("assistant", "⚠ Could not reach the backend.");
  } else {
    addBubble("assistant", result.assistant);
    // Refresh sidebar title after first message
    await loadChatList();
    document.querySelectorAll(".chat-item").forEach(el =>
      el.classList.toggle("active", el.dataset.id === activeChatId)
    );
    chatLabel.textContent = result.assistant ? (await api(`/api/chats/${activeChatId}`))?.title || "Chat" : "Chat";
  }

  sendBtn.disabled = false;
  msgInput.focus();
  scrollDown();
}

// ── Render helpers ───────────────────────────────────────────
function addBubble(role, content) {
  // Remove empty state if present
  document.getElementById("empty-state")?.remove();

  const div = document.createElement("div");
  div.className = `msg ${role}`;
  div.innerHTML = `<div class="bubble">${esc(content)}</div>`;
  messages.appendChild(div);
  return div;
}

function addTyping() {
  document.getElementById("empty-state")?.remove();
  const div = document.createElement("div");
  div.className = "msg assistant";
  div.innerHTML = `<div class="bubble"><div class="typing-dots"><span></span><span></span><span></span></div></div>`;
  messages.appendChild(div);
  scrollDown();
  return div;
}

function scrollDown() {
  messages.scrollTop = messages.scrollHeight;
}

function esc(s) {
  return String(s ?? "")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}
</script>
</body>
</html>
